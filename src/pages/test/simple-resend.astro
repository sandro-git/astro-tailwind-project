---
// src/pages/test/simple-resend.astro
import Layout from "../../layouts/Layout.astro";

let result = null;
let error = null;

if (Astro.request.method === "POST") {
  try {
    const formData = await Astro.request.formData();
    const testEmail = formData.get("testEmail") as string;

    if (testEmail && import.meta.env.RESEND_API_KEY) {
      // Test direct avec l'API Resend
      const response = await fetch("https://api.resend.com/emails", {
        method: "POST",
        headers: {
          Authorization: `Bearer ${import.meta.env.RESEND_API_KEY}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          from: "onboarding@resend.dev",
          to: [testEmail],
          subject: "Test Resend - VR Experience",
          html: `
            <h1>Test Email Resend</h1>
            <p>Si vous recevez cet email, Resend fonctionne correctement !</p>
            <p>Envoyé le : ${new Date().toLocaleString("fr-FR")}</p>
          `,
        }),
      });

      if (response.ok) {
        const data = await response.json();
        result = { success: true, data };
      } else {
        const errorData = await response.text();
        error = `Erreur ${response.status}: ${errorData}`;
      }
    } else {
      error = "Email ou clé API manquant";
    }
  } catch (e) {
    error = e instanceof Error ? e.message : "Erreur inconnue";
  }
}
---

<Layout title="Test Simple Resend">
  <div class="container mx-auto py-8 px-4 max-w-2xl">
    <h1 class="text-3xl font-bold mb-6">Test Simple Resend</h1>

    <!-- Vérification des variables d'environnement -->
    <div class="mb-6 p-4 bg-gray-50 rounded-lg">
      <h2 class="text-xl font-semibold mb-3">Configuration</h2>
      <div class="space-y-2">
        <div class="flex items-center justify-between">
          <span>RESEND_API_KEY:</span>
          {
            import.meta.env.RESEND_API_KEY ? (
              <span class="text-green-600">✅ Configurée</span>
            ) : (
              <span class="text-red-600">❌ Manquante</span>
            )
          }
        </div>
      </div>
    </div>

    <!-- Formulaire de test -->
    {
      import.meta.env.RESEND_API_KEY ? (
        <form method="POST" class="bg-white p-6 rounded-lg shadow border mb-6">
          <h2 class="text-xl font-semibold mb-4">Test d'Envoi</h2>
          <div class="mb-4">
            <label
              for="testEmail"
              class="block text-sm font-medium text-gray-700 mb-2"
            >
              Votre email de test
            </label>
            <input
              type="email"
              id="testEmail"
              name="testEmail"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="votre@email.com"
            />
          </div>
          <button
            type="submit"
            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
          >
            Envoyer un email de test
          </button>
        </form>
      ) : (
        <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
          <h3 class="font-medium text-red-800">Configuration Requise</h3>
          <p class="text-red-600 text-sm mt-1">
            Créez un fichier .env avec votre clé API Resend :
          </p>
          <pre class="bg-red-100 p-2 rounded text-xs mt-2">
            RESEND_API_KEY=re_votre_cle_api_ici
          </pre>
        </div>
      )
    }

    <!-- Résultats -->
    {
      result && (
        <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
          <h3 class="font-medium text-green-800">
            ✅ Email envoyé avec succès !
          </h3>
          <p class="text-green-600 text-sm mt-1">
            ID: {result.data?.id || "Non disponible"}
          </p>
          <details class="mt-2">
            <summary class="cursor-pointer text-sm font-medium">
              Détails
            </summary>
            <pre class="text-xs bg-green-100 p-2 rounded mt-1">
              {JSON.stringify(result.data, null, 2)}
            </pre>
          </details>
        </div>
      )
    }

    {
      error && (
        <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
          <h3 class="font-medium text-red-800">❌ Erreur</h3>
          <p class="text-red-600 text-sm mt-1">{error}</p>
        </div>
      )
    }

    <!-- Instructions -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
      <h3 class="font-medium text-blue-800 mb-2">Instructions</h3>
      <ol class="text-blue-700 text-sm space-y-1 list-decimal list-inside">
        <li>
          Créez un compte sur <a href="https://resend.com" class="underline"
            >resend.com</a>
        </li>
        <li>Obtenez votre clé API (commence par "re_")</li>
        <li>Créez un fichier .env avec RESEND_API_KEY=votre_clé</li>
        <li>Redémarrez le serveur de développement</li>
        <li>Testez l'envoi d'email ci-dessus</li>
      </ol>

      <div class="mt-3 text-xs text-blue-600">
        <p>
          <strong>Note :</strong> Sans domaine vérifié, les emails ne seront envoyés
          qu'à l'adresse de votre compte Resend.
        </p>
      </div>
    </div>
  </div>
</Layout>
